# æ•°æ®åº“è¿ç§»æŒ‡å—

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒè¿ç§»æœ€ä½³å®è·µ

### âœ… æ¨èçš„åšæ³•ï¼ˆå·²å®ç°ï¼‰

1. **ç‹¬ç«‹çš„SQLæ–‡ä»¶**: å°†SQLä»£ç ä»åº”ç”¨ä»£ç ä¸­åˆ†ç¦»
2. **ç‰ˆæœ¬æ§åˆ¶**: ä½¿ç”¨æ—¶é—´æˆ³å‘½åç¡®ä¿è¿ç§»é¡ºåº
3. **åŸå­æ€§**: æ¯ä¸ªè¿ç§»æ–‡ä»¶ä½œä¸ºå•ä¸ªäº‹åŠ¡æ‰§è¡Œ
4. **å¯å›æ»š**: æ”¯æŒè¿ç§»å›æ»šåŠŸèƒ½
5. **CLIå·¥å…·**: ç‹¬ç«‹çš„è¿ç§»ç®¡ç†å·¥å…·

### âŒ é¿å…çš„åšæ³•ï¼ˆåŸå®ç°ï¼‰

1. **ç¡¬ç¼–ç SQL**: åœ¨ä»£ç ä¸­ç›´æ¥å†™SQLè¯­å¥
2. **æ— ç‰ˆæœ¬è¿½è¸ª**: æ— æ³•ç¡®å®šæ•°æ®åº“å½“å‰çŠ¶æ€
3. **ä¸å¯å›æ»š**: å‡ºç°é—®é¢˜æ—¶éš¾ä»¥æ¢å¤
4. **æ··åˆå…³æ³¨ç‚¹**: ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®åº“ç»“æ„æ··åˆ

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œè¿ç§»
```bash
# åº”ç”¨æ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»
cargo run --bin migrate up
```

### å›æ»šè¿ç§»
```bash
# å›æ»šæœ€è¿‘çš„1æ­¥è¿ç§»
cargo run --bin migrate down 1

# å›æ»šæœ€è¿‘çš„3æ­¥è¿ç§»
cargo run --bin migrate down 3
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/migrations/
â”œâ”€â”€ 20241201000001_create_users_table.sql   # åˆ›å»ºç”¨æˆ·è¡¨
â”œâ”€â”€ 20241201000002_add_user_roles.sql       # æ·»åŠ ç”¨æˆ·è§’è‰²ï¼ˆç¤ºä¾‹ï¼‰
â””â”€â”€ 20241201000003_create_posts_table.sql   # åˆ›å»ºæ–‡ç« è¡¨ï¼ˆç¤ºä¾‹ï¼‰
```

## ğŸ“ åˆ›å»ºæ–°è¿ç§»

### 1. å‘½åè§„èŒƒ
```
{timestamp}_{description}.sql
```
ä¾‹å¦‚ï¼š`20241201120000_add_email_verification.sql`

### 2. è¿ç§»æ–‡ä»¶å†…å®¹
```sql
-- 20241201120000_add_email_verification.sql
-- æ·»åŠ é‚®ç®±éªŒè¯åŠŸèƒ½

ALTER TABLE users 
ADD COLUMN email_verified BOOLEAN DEFAULT FALSE,
ADD COLUMN verification_token VARCHAR(255);

CREATE INDEX idx_users_verification_token ON users(verification_token);
```

## ğŸ­ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹

### 1. å¼€å‘ç¯å¢ƒ
```bash
# 1. åˆ›å»ºè¿ç§»æ–‡ä»¶
# 2. æµ‹è¯•è¿ç§»
cargo run --bin migrate up

# 3. æµ‹è¯•å›æ»š
cargo run --bin migrate down 1
cargo run --bin migrate up
```

### 2. æµ‹è¯•ç¯å¢ƒ
```bash
# éƒ¨ç½²å‰è¿è¡Œè¿ç§»
cargo run --bin migrate up
```

### 3. ç”Ÿäº§ç¯å¢ƒ
```bash
# å¤‡ä»½æ•°æ®åº“
pg_dump your_database > backup_$(date +%Y%m%d_%H%M%S).sql

# è¿è¡Œè¿ç§»
cargo run --bin migrate up

# éªŒè¯è¿ç§»ç»“æœ
psql -d your_database -c "\dt"  # æ£€æŸ¥è¡¨ç»“æ„
```

## ğŸ”§ SQLx è¿ç§»ç³»ç»Ÿç‰¹æ€§

### è‡ªåŠ¨è¿½è¸ª
- SQLx è‡ªåŠ¨åˆ›å»º `_sqlx_migrations` è¡¨æ¥è¿½è¸ªè¿ç§»å†å²
- æ¯ä¸ªè¿ç§»åªä¼šæ‰§è¡Œä¸€æ¬¡
- æ”¯æŒæ ¡éªŒå’Œæ£€æŸ¥ï¼Œé˜²æ­¢è¿ç§»æ–‡ä»¶è¢«æ„å¤–ä¿®æ”¹

### äº‹åŠ¡å®‰å…¨
- æ¯ä¸ªè¿ç§»æ–‡ä»¶åœ¨å•ç‹¬çš„äº‹åŠ¡ä¸­æ‰§è¡Œ
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šï¼Œä¿è¯æ•°æ®åº“ä¸€è‡´æ€§

### æ€§èƒ½ä¼˜åŒ–
- æ”¯æŒå¹¶å‘å®‰å…¨çš„è¿ç§»æ‰§è¡Œ
- é€‚åˆç”Ÿäº§ç¯å¢ƒçš„é«˜å¯ç”¨éƒ¨ç½²

## ğŸŒŸ ä¸å…¶ä»–å·¥å…·å¯¹æ¯”

| ç‰¹æ€§ | è‡ªå®šä¹‰ä»£ç  | SQLx Migrate | Diesel | Sea-ORM |
|------|------------|--------------|---------|---------|
| SQLæ–‡ä»¶æ”¯æŒ | âŒ | âœ… | âœ… | âœ… |
| ç‰ˆæœ¬è¿½è¸ª | âŒ | âœ… | âœ… | âœ… |
| å›æ»šæ”¯æŒ | âŒ | âœ… | âœ… | âœ… |
| CLIå·¥å…· | âŒ | âœ… | âœ… | âœ… |
| å­¦ä¹ æˆæœ¬ | ä½ | ä½ | ä¸­ | ä¸­ |

## ğŸ“š å‚è€ƒèµ„æº

- [SQLx Migrations æ–‡æ¡£](https://docs.rs/sqlx/latest/sqlx/migrate/index.html)
- [æ•°æ®åº“è¿ç§»æœ€ä½³å®è·µ](https://martinfowler.com/articles/evodb.html)
- [PostgreSQL è¿ç§»ç­–ç•¥](https://www.postgresql.org/docs/current/ddl-alter.html)